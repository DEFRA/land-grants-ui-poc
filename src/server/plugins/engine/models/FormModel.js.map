{"version":3,"file":"FormModel.js","names":["ConditionsModel","ControllerPath","ControllerType","Engine","formDefinitionSchema","hasRepeater","add","Parser","joi","findPage","getError","getPage","createPage","validationOptions","opts","defaultServices","FormAction","merge","FormModel","engine","def","lists","sections","name","values","basePath","conditions","pages","services","constructor","options","result","validate","abortEarly","error","structuredClone","value","push","title","type","items","text","forEach","conditionDef","condition","makeCondition","map","pageDef","some","controller","Status","path","makeSchema","makeFilteredSchema","relevantPages","schema","object","required","page","concat","collection","stateSchema","parser","operators","logical","Object","assign","functions","dateForComparison","timePeriod","timeUnit","Date","toISOString","displayName","expr","toConditionExpression","fn","evaluationState","ctx","toConditionContext","evaluate","context","key","defineProperty","get","from","parse","toExpression","getList","find","list","getFormContext","request","state","query","currentPath","startPath","getStartPath","isForceAccess","relevantState","payload","getFormDataFromState","paths","validateFormPayload","nextPage","initialiseContext","assignEvaluationState","assignRelevantState","getNextPath","validateFormState","assignPaths","V2","keys","getContextValueFromState","errors","includes","action","getFormParams","Validate","formState","getStateFromValidForm","previousPages","filter","relevantPage","model","stripUnknown","errorsState","details"],"sources":["../../../../../src/server/plugins/engine/models/FormModel.ts"],"sourcesContent":["import {\n  ConditionsModel,\n  ControllerPath,\n  ControllerType,\n  Engine,\n  formDefinitionSchema,\n  hasRepeater,\n  type ConditionWrapper,\n  type ConditionsModelData,\n  type DateUnits,\n  type FormDefinition,\n  type List\n} from '@defra/forms-model'\nimport { add } from 'date-fns'\nimport { Parser, type Value } from 'expr-eval'\nimport joi from 'joi'\n\nimport {\n  findPage,\n  getError,\n  getPage\n} from '~/src/server/plugins/engine/helpers.js'\nimport { type ExecutableCondition } from '~/src/server/plugins/engine/models/types.js'\nimport {\n  createPage,\n  type PageControllerClass\n} from '~/src/server/plugins/engine/pageControllers/helpers.js'\nimport { validationOptions as opts } from '~/src/server/plugins/engine/pageControllers/validationOptions.js'\nimport * as defaultServices from '~/src/server/plugins/engine/services/index.js'\nimport {\n  type FormContext,\n  type FormContextRequest,\n  type FormState,\n  type FormSubmissionState\n} from '~/src/server/plugins/engine/types.js'\nimport { FormAction } from '~/src/server/routes/types.js'\nimport { merge } from '~/src/server/services/cacheService.js'\nimport { type Services } from '~/src/server/types.js'\n\nexport class FormModel {\n  /** The runtime engine that should be used */\n  engine?: Engine\n\n  /** the entire form JSON as an object */\n  def: FormDefinition\n\n  lists: FormDefinition['lists']\n  sections: FormDefinition['sections'] = []\n  name: string\n  values: FormDefinition\n  basePath: string\n  conditions: Partial<Record<string, ExecutableCondition>>\n  pages: PageControllerClass[]\n  services: Services\n\n  constructor(\n    def: typeof this.def,\n    options: { basePath: string },\n    services: Services = defaultServices\n  ) {\n    const result = formDefinitionSchema.validate(def, { abortEarly: false })\n\n    if (result.error) {\n      throw result.error\n    }\n\n    // Make a clone of the shallow copy returned\n    // by joi so as not to change the source data.\n    def = structuredClone(result.value)\n\n    // Add default lists\n    def.lists.push({\n      name: '__yesNo',\n      title: 'Yes/No',\n      type: 'boolean',\n      items: [\n        {\n          text: 'Yes',\n          value: true\n        },\n        {\n          text: 'No',\n          value: false\n        }\n      ]\n    })\n\n    this.engine = def.engine\n    this.def = def\n    this.lists = def.lists\n    this.sections = def.sections\n    this.name = def.name ?? ''\n    this.values = result.value\n    this.basePath = options.basePath\n    this.conditions = {}\n    this.services = services\n\n    def.conditions.forEach((conditionDef) => {\n      const condition = this.makeCondition(conditionDef)\n      this.conditions[condition.name] = condition\n    })\n\n    this.pages = def.pages.map((pageDef) => createPage(this, pageDef))\n\n    if (\n      !def.pages.some(\n        ({ controller }) =>\n          // Check for user-provided status page (optional)\n          controller === ControllerType.Status\n      )\n    ) {\n      this.pages.push(\n        createPage(this, {\n          title: 'Form submitted',\n          path: ControllerPath.Status,\n          controller: ControllerType.Status\n        })\n      )\n    }\n  }\n\n  /**\n   * build the entire model schema from individual pages/sections\n   */\n  makeSchema() {\n    return this.makeFilteredSchema(this.pages)\n  }\n\n  /**\n   * build the entire model schema from individual pages/sections and filter out answers\n   * for pages which are no longer accessible due to an answer that has been changed\n   */\n  makeFilteredSchema(relevantPages: PageControllerClass[]) {\n    // Build the entire model schema\n    // from the individual pages/sections\n    let schema = joi.object<FormSubmissionState>().required()\n\n    relevantPages.forEach((page) => {\n      schema = schema.concat(page.collection.stateSchema)\n    })\n\n    return schema\n  }\n\n  /**\n   * Instantiates a Condition based on {@link ConditionWrapper}\n   * @param condition\n   */\n  makeCondition(condition: ConditionWrapper): ExecutableCondition {\n    const parser = new Parser({\n      operators: {\n        logical: true\n      }\n    })\n\n    Object.assign(parser.functions, {\n      dateForComparison(timePeriod: number, timeUnit: DateUnits) {\n        return add(new Date(), { [timeUnit]: timePeriod }).toISOString()\n      }\n    })\n\n    const { name, displayName, value } = condition\n    const expr = this.toConditionExpression(value, parser)\n\n    const fn = (evaluationState: FormState) => {\n      const ctx = this.toConditionContext(evaluationState, this.conditions)\n      try {\n        return expr.evaluate(ctx) as boolean\n      } catch {\n        return false\n      }\n    }\n\n    return {\n      name,\n      displayName,\n      value,\n      expr,\n      fn\n    }\n  }\n\n  toConditionContext(\n    evaluationState: FormState,\n    conditions: Partial<Record<string, ExecutableCondition>>\n  ) {\n    const context = { ...evaluationState }\n\n    for (const key in conditions) {\n      Object.defineProperty(context, key, {\n        get() {\n          return conditions[key]?.fn(evaluationState)\n        }\n      })\n    }\n\n    return context as Extract<Value, Record<string, Value>>\n  }\n\n  toConditionExpression(value: ConditionsModelData, parser: Parser) {\n    const conditions = ConditionsModel.from(value)\n    return parser.parse(conditions.toExpression())\n  }\n\n  getList(name: string): List | undefined {\n    return this.lists.find((list) => list.name === name)\n  }\n\n  /**\n   * Form context for the current page\n   */\n  getFormContext(request: FormContextRequest, state: FormState): FormContext {\n    const { query } = request\n\n    const page = getPage(this, request)\n\n    // Determine form paths\n    const currentPath = page.path\n    const startPath = page.getStartPath()\n\n    // Preview URL direct access is allowed\n    const isForceAccess = 'force' in query\n\n    let context: FormContext = {\n      evaluationState: {},\n      relevantState: {},\n      relevantPages: [],\n      payload: page.getFormDataFromState(request, state),\n      state,\n      paths: [],\n      isForceAccess\n    }\n\n    // Validate current page\n    context = validateFormPayload(request, page, context)\n\n    // Find start page\n    let nextPage = findPage(this, startPath)\n\n    this.initialiseContext(context)\n\n    // Walk form pages from start\n    while (nextPage) {\n      // Add page to context\n      context.relevantPages.push(nextPage)\n\n      this.assignEvaluationState(context, nextPage)\n\n      this.assignRelevantState(context, nextPage)\n\n      // Stop at current page\n      if (nextPage.path === currentPath) {\n        break\n      }\n\n      // Apply conditions to determine next page\n      nextPage = findPage(this, nextPage.getNextPath(context))\n    }\n\n    // Validate form state\n    context = validateFormState(request, page, context)\n\n    // Add paths for navigation\n    this.assignPaths(context)\n\n    return context\n  }\n\n  private initialiseContext(context: FormContext) {\n    // For the V2 engine, we need to initialise `evaluationState` to null\n    // for all keys. This is because the current condition evaluation\n    // library (eval-expr) will throw if an expression uses a key that is undefined.\n    if (this.engine === Engine.V2) {\n      for (const page of this.pages) {\n        for (const key of page.keys) {\n          context.evaluationState[key] = null\n        }\n      }\n    }\n  }\n\n  private assignEvaluationState(\n    context: FormContext,\n    page: PageControllerClass\n  ) {\n    const { collection, pageDef } = page\n    // Skip evaluation state for repeater pages\n\n    if (!hasRepeater(pageDef)) {\n      Object.assign(\n        context.evaluationState,\n        collection.getContextValueFromState(context.state)\n      )\n    }\n  }\n\n  private assignRelevantState(context: FormContext, page: PageControllerClass) {\n    // Copy relevant state by expected keys\n    for (const key of page.keys) {\n      if (typeof context.state[key] !== 'undefined') {\n        context.relevantState[key] = context.state[key]\n      }\n    }\n  }\n\n  private assignPaths(context: FormContext) {\n    for (const { keys, path } of context.relevantPages) {\n      context.paths.push(path)\n\n      // Stop at page with errors\n      if (\n        context.errors?.some(({ name, path }) => {\n          return keys.includes(name) || keys.some((key) => path.includes(key))\n        })\n      ) {\n        break\n      }\n    }\n  }\n}\n\n/**\n * Validate current page only\n */\nfunction validateFormPayload(\n  request: FormContextRequest,\n  page: PageControllerClass,\n  context: FormContext\n): FormContext {\n  const { collection } = page\n  const { payload, state } = context\n\n  const { action } = page.getFormParams(request)\n\n  // Skip validation GET requests or other actions\n  if (!request.payload || action !== FormAction.Validate) {\n    return context\n  }\n\n  // Validate form data into payload\n  const { value, errors } = collection.validate({\n    ...payload,\n    ...request.payload\n  })\n\n  // Add sanitised payload (ready to save)\n  const formState = page.getStateFromValidForm(request, state, value)\n\n  return {\n    ...context,\n    payload: merge(payload, value),\n    state: merge(state, formState),\n    errors\n  }\n}\n\n/**\n * Validate entire form state\n */\nfunction validateFormState(\n  request: FormContextRequest,\n  page: PageControllerClass,\n  context: FormContext\n): FormContext {\n  const { errors = [], relevantPages, relevantState } = context\n\n  // Exclude current page\n  const previousPages = relevantPages.filter(\n    (relevantPage) => relevantPage !== page\n  )\n\n  // Validate relevant state\n  const { error } = page.model\n    .makeFilteredSchema(previousPages)\n    .validate(relevantState, { ...opts, stripUnknown: true })\n\n  // Add relevant state errors\n  if (error) {\n    const errorsState = error.details.map(getError)\n    return { ...context, errors: errors.concat(errorsState) }\n  }\n\n  return context\n}\n"],"mappings":"AAAA,SACEA,eAAe,EACfC,cAAc,EACdC,cAAc,EACdC,MAAM,EACNC,oBAAoB,EACpBC,WAAW,QAMN,oBAAoB;AAC3B,SAASC,GAAG,QAAQ,UAAU;AAC9B,SAASC,MAAM,QAAoB,WAAW;AAC9C,OAAOC,GAAG,MAAM,KAAK;AAErB,SACEC,QAAQ,EACRC,QAAQ,EACRC,OAAO;AAGT,SACEC,UAAU;AAGZ,SAASC,iBAAiB,IAAIC,IAAI;AAClC,OAAO,KAAKC,eAAe;AAO3B,SAASC,UAAU;AACnB,SAASC,KAAK;AAGd,OAAO,MAAMC,SAAS,CAAC;EACrB;EACAC,MAAM;;EAEN;EACAC,GAAG;EAEHC,KAAK;EACLC,QAAQ,GAA+B,EAAE;EACzCC,IAAI;EACJC,MAAM;EACNC,QAAQ;EACRC,UAAU;EACVC,KAAK;EACLC,QAAQ;EAERC,WAAWA,CACTT,GAAoB,EACpBU,OAA6B,EAC7BF,QAAkB,GAAGb,eAAe,EACpC;IACA,MAAMgB,MAAM,GAAG3B,oBAAoB,CAAC4B,QAAQ,CAACZ,GAAG,EAAE;MAAEa,UAAU,EAAE;IAAM,CAAC,CAAC;IAExE,IAAIF,MAAM,CAACG,KAAK,EAAE;MAChB,MAAMH,MAAM,CAACG,KAAK;IACpB;;IAEA;IACA;IACAd,GAAG,GAAGe,eAAe,CAACJ,MAAM,CAACK,KAAK,CAAC;;IAEnC;IACAhB,GAAG,CAACC,KAAK,CAACgB,IAAI,CAAC;MACbd,IAAI,EAAE,SAAS;MACfe,KAAK,EAAE,QAAQ;MACfC,IAAI,EAAE,SAAS;MACfC,KAAK,EAAE,CACL;QACEC,IAAI,EAAE,KAAK;QACXL,KAAK,EAAE;MACT,CAAC,EACD;QACEK,IAAI,EAAE,IAAI;QACVL,KAAK,EAAE;MACT,CAAC;IAEL,CAAC,CAAC;IAEF,IAAI,CAACjB,MAAM,GAAGC,GAAG,CAACD,MAAM;IACxB,IAAI,CAACC,GAAG,GAAGA,GAAG;IACd,IAAI,CAACC,KAAK,GAAGD,GAAG,CAACC,KAAK;IACtB,IAAI,CAACC,QAAQ,GAAGF,GAAG,CAACE,QAAQ;IAC5B,IAAI,CAACC,IAAI,GAAGH,GAAG,CAACG,IAAI,IAAI,EAAE;IAC1B,IAAI,CAACC,MAAM,GAAGO,MAAM,CAACK,KAAK;IAC1B,IAAI,CAACX,QAAQ,GAAGK,OAAO,CAACL,QAAQ;IAChC,IAAI,CAACC,UAAU,GAAG,CAAC,CAAC;IACpB,IAAI,CAACE,QAAQ,GAAGA,QAAQ;IAExBR,GAAG,CAACM,UAAU,CAACgB,OAAO,CAAEC,YAAY,IAAK;MACvC,MAAMC,SAAS,GAAG,IAAI,CAACC,aAAa,CAACF,YAAY,CAAC;MAClD,IAAI,CAACjB,UAAU,CAACkB,SAAS,CAACrB,IAAI,CAAC,GAAGqB,SAAS;IAC7C,CAAC,CAAC;IAEF,IAAI,CAACjB,KAAK,GAAGP,GAAG,CAACO,KAAK,CAACmB,GAAG,CAAEC,OAAO,IAAKnC,UAAU,CAAC,IAAI,EAAEmC,OAAO,CAAC,CAAC;IAElE,IACE,CAAC3B,GAAG,CAACO,KAAK,CAACqB,IAAI,CACb,CAAC;MAAEC;IAAW,CAAC;IACb;IACAA,UAAU,KAAK/C,cAAc,CAACgD,MAClC,CAAC,EACD;MACA,IAAI,CAACvB,KAAK,CAACU,IAAI,CACbzB,UAAU,CAAC,IAAI,EAAE;QACf0B,KAAK,EAAE,gBAAgB;QACvBa,IAAI,EAAElD,cAAc,CAACiD,MAAM;QAC3BD,UAAU,EAAE/C,cAAc,CAACgD;MAC7B,CAAC,CACH,CAAC;IACH;EACF;;EAEA;AACF;AACA;EACEE,UAAUA,CAAA,EAAG;IACX,OAAO,IAAI,CAACC,kBAAkB,CAAC,IAAI,CAAC1B,KAAK,CAAC;EAC5C;;EAEA;AACF;AACA;AACA;EACE0B,kBAAkBA,CAACC,aAAoC,EAAE;IACvD;IACA;IACA,IAAIC,MAAM,GAAG/C,GAAG,CAACgD,MAAM,CAAsB,CAAC,CAACC,QAAQ,CAAC,CAAC;IAEzDH,aAAa,CAACZ,OAAO,CAAEgB,IAAI,IAAK;MAC9BH,MAAM,GAAGA,MAAM,CAACI,MAAM,CAACD,IAAI,CAACE,UAAU,CAACC,WAAW,CAAC;IACrD,CAAC,CAAC;IAEF,OAAON,MAAM;EACf;;EAEA;AACF;AACA;AACA;EACEV,aAAaA,CAACD,SAA2B,EAAuB;IAC9D,MAAMkB,MAAM,GAAG,IAAIvD,MAAM,CAAC;MACxBwD,SAAS,EAAE;QACTC,OAAO,EAAE;MACX;IACF,CAAC,CAAC;IAEFC,MAAM,CAACC,MAAM,CAACJ,MAAM,CAACK,SAAS,EAAE;MAC9BC,iBAAiBA,CAACC,UAAkB,EAAEC,QAAmB,EAAE;QACzD,OAAOhE,GAAG,CAAC,IAAIiE,IAAI,CAAC,CAAC,EAAE;UAAE,CAACD,QAAQ,GAAGD;QAAW,CAAC,CAAC,CAACG,WAAW,CAAC,CAAC;MAClE;IACF,CAAC,CAAC;IAEF,MAAM;MAAEjD,IAAI;MAAEkD,WAAW;MAAErC;IAAM,CAAC,GAAGQ,SAAS;IAC9C,MAAM8B,IAAI,GAAG,IAAI,CAACC,qBAAqB,CAACvC,KAAK,EAAE0B,MAAM,CAAC;IAEtD,MAAMc,EAAE,GAAIC,eAA0B,IAAK;MACzC,MAAMC,GAAG,GAAG,IAAI,CAACC,kBAAkB,CAACF,eAAe,EAAE,IAAI,CAACnD,UAAU,CAAC;MACrE,IAAI;QACF,OAAOgD,IAAI,CAACM,QAAQ,CAACF,GAAG,CAAC;MAC3B,CAAC,CAAC,MAAM;QACN,OAAO,KAAK;MACd;IACF,CAAC;IAED,OAAO;MACLvD,IAAI;MACJkD,WAAW;MACXrC,KAAK;MACLsC,IAAI;MACJE;IACF,CAAC;EACH;EAEAG,kBAAkBA,CAChBF,eAA0B,EAC1BnD,UAAwD,EACxD;IACA,MAAMuD,OAAO,GAAG;MAAE,GAAGJ;IAAgB,CAAC;IAEtC,KAAK,MAAMK,GAAG,IAAIxD,UAAU,EAAE;MAC5BuC,MAAM,CAACkB,cAAc,CAACF,OAAO,EAAEC,GAAG,EAAE;QAClCE,GAAGA,CAAA,EAAG;UACJ,OAAO1D,UAAU,CAACwD,GAAG,CAAC,EAAEN,EAAE,CAACC,eAAe,CAAC;QAC7C;MACF,CAAC,CAAC;IACJ;IAEA,OAAOI,OAAO;EAChB;EAEAN,qBAAqBA,CAACvC,KAA0B,EAAE0B,MAAc,EAAE;IAChE,MAAMpC,UAAU,GAAG1B,eAAe,CAACqF,IAAI,CAACjD,KAAK,CAAC;IAC9C,OAAO0B,MAAM,CAACwB,KAAK,CAAC5D,UAAU,CAAC6D,YAAY,CAAC,CAAC,CAAC;EAChD;EAEAC,OAAOA,CAACjE,IAAY,EAAoB;IACtC,OAAO,IAAI,CAACF,KAAK,CAACoE,IAAI,CAAEC,IAAI,IAAKA,IAAI,CAACnE,IAAI,KAAKA,IAAI,CAAC;EACtD;;EAEA;AACF;AACA;EACEoE,cAAcA,CAACC,OAA2B,EAAEC,KAAgB,EAAe;IACzE,MAAM;MAAEC;IAAM,CAAC,GAAGF,OAAO;IAEzB,MAAMlC,IAAI,GAAG/C,OAAO,CAAC,IAAI,EAAEiF,OAAO,CAAC;;IAEnC;IACA,MAAMG,WAAW,GAAGrC,IAAI,CAACP,IAAI;IAC7B,MAAM6C,SAAS,GAAGtC,IAAI,CAACuC,YAAY,CAAC,CAAC;;IAErC;IACA,MAAMC,aAAa,GAAG,OAAO,IAAIJ,KAAK;IAEtC,IAAIb,OAAoB,GAAG;MACzBJ,eAAe,EAAE,CAAC,CAAC;MACnBsB,aAAa,EAAE,CAAC,CAAC;MACjB7C,aAAa,EAAE,EAAE;MACjB8C,OAAO,EAAE1C,IAAI,CAAC2C,oBAAoB,CAACT,OAAO,EAAEC,KAAK,CAAC;MAClDA,KAAK;MACLS,KAAK,EAAE,EAAE;MACTJ;IACF,CAAC;;IAED;IACAjB,OAAO,GAAGsB,mBAAmB,CAACX,OAAO,EAAElC,IAAI,EAAEuB,OAAO,CAAC;;IAErD;IACA,IAAIuB,QAAQ,GAAG/F,QAAQ,CAAC,IAAI,EAAEuF,SAAS,CAAC;IAExC,IAAI,CAACS,iBAAiB,CAACxB,OAAO,CAAC;;IAE/B;IACA,OAAOuB,QAAQ,EAAE;MACf;MACAvB,OAAO,CAAC3B,aAAa,CAACjB,IAAI,CAACmE,QAAQ,CAAC;MAEpC,IAAI,CAACE,qBAAqB,CAACzB,OAAO,EAAEuB,QAAQ,CAAC;MAE7C,IAAI,CAACG,mBAAmB,CAAC1B,OAAO,EAAEuB,QAAQ,CAAC;;MAE3C;MACA,IAAIA,QAAQ,CAACrD,IAAI,KAAK4C,WAAW,EAAE;QACjC;MACF;;MAEA;MACAS,QAAQ,GAAG/F,QAAQ,CAAC,IAAI,EAAE+F,QAAQ,CAACI,WAAW,CAAC3B,OAAO,CAAC,CAAC;IAC1D;;IAEA;IACAA,OAAO,GAAG4B,iBAAiB,CAACjB,OAAO,EAAElC,IAAI,EAAEuB,OAAO,CAAC;;IAEnD;IACA,IAAI,CAAC6B,WAAW,CAAC7B,OAAO,CAAC;IAEzB,OAAOA,OAAO;EAChB;EAEQwB,iBAAiBA,CAACxB,OAAoB,EAAE;IAC9C;IACA;IACA;IACA,IAAI,IAAI,CAAC9D,MAAM,KAAKhB,MAAM,CAAC4G,EAAE,EAAE;MAC7B,KAAK,MAAMrD,IAAI,IAAI,IAAI,CAAC/B,KAAK,EAAE;QAC7B,KAAK,MAAMuD,GAAG,IAAIxB,IAAI,CAACsD,IAAI,EAAE;UAC3B/B,OAAO,CAACJ,eAAe,CAACK,GAAG,CAAC,GAAG,IAAI;QACrC;MACF;IACF;EACF;EAEQwB,qBAAqBA,CAC3BzB,OAAoB,EACpBvB,IAAyB,EACzB;IACA,MAAM;MAAEE,UAAU;MAAEb;IAAQ,CAAC,GAAGW,IAAI;IACpC;;IAEA,IAAI,CAACrD,WAAW,CAAC0C,OAAO,CAAC,EAAE;MACzBkB,MAAM,CAACC,MAAM,CACXe,OAAO,CAACJ,eAAe,EACvBjB,UAAU,CAACqD,wBAAwB,CAAChC,OAAO,CAACY,KAAK,CACnD,CAAC;IACH;EACF;EAEQc,mBAAmBA,CAAC1B,OAAoB,EAAEvB,IAAyB,EAAE;IAC3E;IACA,KAAK,MAAMwB,GAAG,IAAIxB,IAAI,CAACsD,IAAI,EAAE;MAC3B,IAAI,OAAO/B,OAAO,CAACY,KAAK,CAACX,GAAG,CAAC,KAAK,WAAW,EAAE;QAC7CD,OAAO,CAACkB,aAAa,CAACjB,GAAG,CAAC,GAAGD,OAAO,CAACY,KAAK,CAACX,GAAG,CAAC;MACjD;IACF;EACF;EAEQ4B,WAAWA,CAAC7B,OAAoB,EAAE;IACxC,KAAK,MAAM;MAAE+B,IAAI;MAAE7D;IAAK,CAAC,IAAI8B,OAAO,CAAC3B,aAAa,EAAE;MAClD2B,OAAO,CAACqB,KAAK,CAACjE,IAAI,CAACc,IAAI,CAAC;;MAExB;MACA,IACE8B,OAAO,CAACiC,MAAM,EAAElE,IAAI,CAAC,CAAC;QAAEzB,IAAI;QAAE4B;MAAK,CAAC,KAAK;QACvC,OAAO6D,IAAI,CAACG,QAAQ,CAAC5F,IAAI,CAAC,IAAIyF,IAAI,CAAChE,IAAI,CAAEkC,GAAG,IAAK/B,IAAI,CAACgE,QAAQ,CAACjC,GAAG,CAAC,CAAC;MACtE,CAAC,CAAC,EACF;QACA;MACF;IACF;EACF;AACF;;AAEA;AACA;AACA;AACA,SAASqB,mBAAmBA,CAC1BX,OAA2B,EAC3BlC,IAAyB,EACzBuB,OAAoB,EACP;EACb,MAAM;IAAErB;EAAW,CAAC,GAAGF,IAAI;EAC3B,MAAM;IAAE0C,OAAO;IAAEP;EAAM,CAAC,GAAGZ,OAAO;EAElC,MAAM;IAAEmC;EAAO,CAAC,GAAG1D,IAAI,CAAC2D,aAAa,CAACzB,OAAO,CAAC;;EAE9C;EACA,IAAI,CAACA,OAAO,CAACQ,OAAO,IAAIgB,MAAM,KAAKpG,UAAU,CAACsG,QAAQ,EAAE;IACtD,OAAOrC,OAAO;EAChB;;EAEA;EACA,MAAM;IAAE7C,KAAK;IAAE8E;EAAO,CAAC,GAAGtD,UAAU,CAAC5B,QAAQ,CAAC;IAC5C,GAAGoE,OAAO;IACV,GAAGR,OAAO,CAACQ;EACb,CAAC,CAAC;;EAEF;EACA,MAAMmB,SAAS,GAAG7D,IAAI,CAAC8D,qBAAqB,CAAC5B,OAAO,EAAEC,KAAK,EAAEzD,KAAK,CAAC;EAEnE,OAAO;IACL,GAAG6C,OAAO;IACVmB,OAAO,EAAEnF,KAAK,CAACmF,OAAO,EAAEhE,KAAK,CAAC;IAC9ByD,KAAK,EAAE5E,KAAK,CAAC4E,KAAK,EAAE0B,SAAS,CAAC;IAC9BL;EACF,CAAC;AACH;;AAEA;AACA;AACA;AACA,SAASL,iBAAiBA,CACxBjB,OAA2B,EAC3BlC,IAAyB,EACzBuB,OAAoB,EACP;EACb,MAAM;IAAEiC,MAAM,GAAG,EAAE;IAAE5D,aAAa;IAAE6C;EAAc,CAAC,GAAGlB,OAAO;;EAE7D;EACA,MAAMwC,aAAa,GAAGnE,aAAa,CAACoE,MAAM,CACvCC,YAAY,IAAKA,YAAY,KAAKjE,IACrC,CAAC;;EAED;EACA,MAAM;IAAExB;EAAM,CAAC,GAAGwB,IAAI,CAACkE,KAAK,CACzBvE,kBAAkB,CAACoE,aAAa,CAAC,CACjCzF,QAAQ,CAACmE,aAAa,EAAE;IAAE,GAAGrF,IAAI;IAAE+G,YAAY,EAAE;EAAK,CAAC,CAAC;;EAE3D;EACA,IAAI3F,KAAK,EAAE;IACT,MAAM4F,WAAW,GAAG5F,KAAK,CAAC6F,OAAO,CAACjF,GAAG,CAACpC,QAAQ,CAAC;IAC/C,OAAO;MAAE,GAAGuE,OAAO;MAAEiC,MAAM,EAAEA,MAAM,CAACvD,MAAM,CAACmE,WAAW;IAAE,CAAC;EAC3D;EAEA,OAAO7C,OAAO;AAChB","ignoreList":[]}