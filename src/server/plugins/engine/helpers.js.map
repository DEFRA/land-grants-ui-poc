{"version":3,"file":"helpers.js","names":["ControllerPath","Engine","Boom","format","parseISO","StatusCodes","upperFirst","createLogger","PREVIEW_PATH_PREFIX","FormAction","FormStatus","logger","proceed","request","h","nextUrl","method","payload","query","returnUrl","isReturnAllowed","action","Continue","Validate","response","isPathRelative","redirect","redirectPath","code","SEE_OTHER","MOVED_TEMPORARILY","encodeUrl","link","URL","toString","err","error","getPageHref","page","pathOrQuery","queryOnly","path","Error","getHref","isRelative","params","Object","entries","filter","url","name","value","searchParams","set","pathname","search","href","startsWith","normalisePath","trim","replace","getPage","model","findPage","notFound","findPath","pages","find","getStartPath","engine","V2","startPath","def","at","Start","startPage","checkFormStatus","isPreview","toLowerCase","state","previewState","split","formState","values","Live","checkEmailAddressForLiveFormSubmission","emailAddress","internal","getErrors","details","length","map","getError","detail","context","message","key","text"],"sources":["../../../../src/server/plugins/engine/helpers.ts"],"sourcesContent":["import { ControllerPath, Engine } from '@defra/forms-model'\nimport Boom from '@hapi/boom'\nimport { type ResponseToolkit } from '@hapi/hapi'\nimport { format, parseISO } from 'date-fns'\nimport { StatusCodes } from 'http-status-codes'\nimport { type Schema, type ValidationErrorItem } from 'joi'\nimport upperFirst from 'lodash/upperFirst.js'\n\nimport { createLogger } from '~/src/server/common/helpers/logging/logger.js'\nimport { PREVIEW_PATH_PREFIX } from '~/src/server/constants.js'\nimport { type FormModel } from '~/src/server/plugins/engine/models/FormModel.js'\nimport { type PageControllerClass } from '~/src/server/plugins/engine/pageControllers/helpers.js'\nimport {\n  type FormContextRequest,\n  type FormSubmissionError\n} from '~/src/server/plugins/engine/types.js'\nimport {\n  FormAction,\n  FormStatus,\n  type FormQuery\n} from '~/src/server/routes/types.js'\n\nconst logger = createLogger()\n\nexport function proceed(\n  request: Pick<FormContextRequest, 'method' | 'payload' | 'query'>,\n  h: Pick<ResponseToolkit, 'redirect' | 'view'>,\n  nextUrl: string\n) {\n  const { method, payload, query } = request\n  const { returnUrl } = query\n\n  const isReturnAllowed =\n    payload && 'action' in payload\n      ? payload.action === FormAction.Continue ||\n        payload.action === FormAction.Validate\n      : false\n\n  // Redirect to return location (optional)\n  const response =\n    isReturnAllowed && isPathRelative(returnUrl)\n      ? h.redirect(returnUrl)\n      : h.redirect(redirectPath(nextUrl))\n\n  // Redirect POST to GET to avoid resubmission\n  return method === 'post'\n    ? response.code(StatusCodes.SEE_OTHER)\n    : response.code(StatusCodes.MOVED_TEMPORARILY)\n}\n\n/**\n * Encodes a URL, returning undefined if the process fails.\n */\nexport function encodeUrl(link?: string) {\n  if (link) {\n    try {\n      return new URL(link).toString() // escape the search params without breaking the ? and & reserved characters in rfc2368\n    } catch (err) {\n      logger.error(err, `Failed to encode ${link}`)\n      throw err\n    }\n  }\n}\n\n/**\n * Get page href\n */\nexport function getPageHref(\n  page: PageControllerClass,\n  query?: FormQuery\n): string\n\n/**\n * Get page href by path\n */\nexport function getPageHref(\n  page: PageControllerClass,\n  path: string,\n  query?: FormQuery\n): string\n\nexport function getPageHref(\n  page: PageControllerClass,\n  pathOrQuery?: string | FormQuery,\n  queryOnly: FormQuery = {}\n) {\n  const path = typeof pathOrQuery === 'string' ? pathOrQuery : page.path\n  const query = typeof pathOrQuery === 'object' ? pathOrQuery : queryOnly\n\n  if (!isPathRelative(path)) {\n    throw Error(`Only relative URLs are allowed: ${path}`)\n  }\n\n  // Return path with page href as base\n  return redirectPath(page.getHref(path), query)\n}\n\n/**\n * Get redirect path with optional query params\n */\nexport function redirectPath(nextUrl: string, query: FormQuery = {}) {\n  const isRelative = isPathRelative(nextUrl)\n\n  // Filter string query params only\n  const params = Object.entries(query).filter(\n    (query): query is [string, string] => typeof query[1] === 'string'\n  )\n\n  // Build URL with relative path support\n  const url = isRelative\n    ? new URL(nextUrl, 'http://example.com')\n    : new URL(nextUrl)\n\n  // Append query params\n  for (const [name, value] of params) {\n    url.searchParams.set(name, value)\n  }\n\n  if (isRelative) {\n    return `${url.pathname}${url.search}`\n  }\n\n  return url.href\n}\n\nexport function isPathRelative(path?: string) {\n  return (path ?? '').startsWith('/')\n}\n\nexport function normalisePath(path = '') {\n  return path\n    .trim() // Trim empty spaces\n    .replace(/^\\//, '') // Remove leading slash\n    .replace(/\\/$/, '') // Remove trailing slash\n}\n\nexport function getPage(\n  model: FormModel | undefined,\n  request: FormContextRequest\n) {\n  const { params } = request\n\n  const page = findPage(model, `/${params.path}`)\n\n  if (!page) {\n    throw Boom.notFound(`No page found for /${params.path}`)\n  }\n\n  return page\n}\n\nexport function findPage(model: FormModel | undefined, path?: string) {\n  const findPath = `/${normalisePath(path)}`\n  return model?.pages.find(({ path }) => path === findPath)\n}\n\nexport function getStartPath(model?: FormModel) {\n  if (model?.engine === Engine.V2) {\n    const startPath = normalisePath(model.def.pages.at(0)?.path)\n    return startPath ? `/${startPath}` : ControllerPath.Start\n  }\n\n  const startPath = normalisePath(model?.def.startPage)\n  return startPath ? `/${startPath}` : ControllerPath.Start\n}\n\nexport function checkFormStatus(path: string) {\n  const isPreview = path.toLowerCase().startsWith(PREVIEW_PATH_PREFIX)\n\n  let state: FormStatus | undefined\n\n  if (isPreview) {\n    const previewState = path.split('/')[2]\n\n    for (const formState of Object.values(FormStatus)) {\n      if (previewState === formState.toString()) {\n        state = formState\n        break\n      }\n    }\n\n    if (!state) {\n      throw new Error(`Invalid form state: ${previewState}`)\n    }\n  }\n\n  return {\n    isPreview,\n    state: state ?? FormStatus.Live\n  }\n}\n\nexport function checkEmailAddressForLiveFormSubmission(\n  emailAddress: string | undefined,\n  isPreview: boolean\n) {\n  if (!emailAddress && !isPreview) {\n    throw Boom.internal(\n      'An email address is required to complete the form submission'\n    )\n  }\n}\n\n/**\n * Parses the errors from {@link Schema.validate} so they can be rendered by govuk-frontend templates\n * @param [details] - provided by {@link Schema.validate}\n */\nexport function getErrors(\n  details?: ValidationErrorItem[]\n): FormSubmissionError[] | undefined {\n  if (!details?.length) {\n    return\n  }\n\n  return details.map(getError)\n}\n\nexport function getError(detail: ValidationErrorItem): FormSubmissionError {\n  const { context, message, path } = detail\n\n  const name = context?.key ?? ''\n  const href = `#${name}`\n\n  const text = upperFirst(\n    message.replace(\n      /\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d\\.\\d+([+-][0-2]\\d:[0-5]\\d|Z)/,\n      (text) => format(parseISO(text), 'd MMMM yyyy')\n    )\n  )\n\n  return {\n    path,\n    href,\n    name,\n    text,\n    context\n  }\n}\n"],"mappings":"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","ignoreList":[]}