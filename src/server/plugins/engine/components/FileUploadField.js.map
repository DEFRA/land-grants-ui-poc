{"version":3,"file":"FileUploadField.js","names":["joi","FormComponent","isUploadState","FileStatus","UploadStatus","render","uploadIdSchema","string","uuid","required","fileSchema","object","fileId","filename","contentLength","number","tempFileSchema","append","fileStatus","valid","complete","rejected","pending","errorMessage","optional","formFileSchema","metadataSchema","keys","retrievalKey","email","tempStatusSchema","uploadStatus","ready","metadata","form","file","numberOfRejectedFiles","formStatusSchema","itemSchema","uploadId","tempItemSchema","status","formItemSchema","FileUploadField","constructor","def","props","options","schema","title","formSchema","array","label","toLowerCase","single","length","max","min","items","stateSchema","default","allow","getFormValueFromState","state","name","getFormValue","value","isValue","undefined","getDisplayStringFromState","files","unit","getContextValueFromState","map","getViewModel","payload","errors","query","page","isForceAccess","viewModel","attributes","id","count","pendingCount","successfulCount","rows","item","index","tag","classes","text","valueHtml","view","context","params","trim","keyHtml","path","href","getHref","push","visuallyHiddenText","key","html","actions","accept","summaryList","upload"],"sources":["../../../../../src/server/plugins/engine/components/FileUploadField.ts"],"sourcesContent":["import { type FileUploadFieldComponent } from '@defra/forms-model'\nimport joi, { type ArraySchema } from 'joi'\n\nimport {\n  FormComponent,\n  isUploadState\n} from '~/src/server/plugins/engine/components/FormComponent.js'\nimport {\n  FileStatus,\n  UploadStatus,\n  type FileState,\n  type FileUpload,\n  type FileUploadMetadata,\n  type FormPayload,\n  type FormState,\n  type FormStateValue,\n  type FormSubmissionError,\n  type FormSubmissionState,\n  type SummaryList,\n  type SummaryListAction,\n  type SummaryListRow,\n  type UploadState,\n  type UploadStatusFileResponse,\n  type UploadStatusResponse\n} from '~/src/server/plugins/engine/types.js'\nimport { render } from '~/src/server/plugins/nunjucks/index.js'\nimport { type FormQuery } from '~/src/server/routes/types.js'\n\nexport const uploadIdSchema = joi.string().uuid().required()\n\nexport const fileSchema = joi\n  .object<FileUpload>({\n    fileId: joi.string().uuid().required(),\n    filename: joi.string().required(),\n    contentLength: joi.number().required()\n  })\n  .required()\n\nexport const tempFileSchema = fileSchema.append({\n  fileStatus: joi\n    .string()\n    .valid(FileStatus.complete, FileStatus.rejected, FileStatus.pending)\n    .required(),\n  errorMessage: joi.string().optional()\n})\n\nexport const formFileSchema = fileSchema.append({\n  fileStatus: joi.string().valid(FileStatus.complete).required()\n})\n\nexport const metadataSchema = joi\n  .object<FileUploadMetadata>()\n  .keys({\n    retrievalKey: joi.string().email().required()\n  })\n  .required()\n\nexport const tempStatusSchema = joi\n  .object<UploadStatusFileResponse>({\n    uploadStatus: joi\n      .string()\n      .valid(UploadStatus.ready, UploadStatus.pending)\n      .required(),\n    metadata: metadataSchema,\n    form: joi.object().required().keys({\n      file: tempFileSchema\n    }),\n    numberOfRejectedFiles: joi.number().optional()\n  })\n  .required()\n\nexport const formStatusSchema = joi\n  .object<UploadStatusResponse>({\n    uploadStatus: joi.string().valid(UploadStatus.ready).required(),\n    metadata: metadataSchema,\n    form: joi.object().required().keys({\n      file: formFileSchema\n    }),\n    numberOfRejectedFiles: joi.number().valid(0).required()\n  })\n  .required()\n\nexport const itemSchema = joi.object<FileState>({\n  uploadId: uploadIdSchema\n})\n\nexport const tempItemSchema = itemSchema.append({\n  status: tempStatusSchema\n})\n\nexport const formItemSchema = itemSchema.append({\n  status: formStatusSchema\n})\n\nexport class FileUploadField extends FormComponent {\n  declare options: FileUploadFieldComponent['options']\n  declare schema: FileUploadFieldComponent['schema']\n  declare formSchema: ArraySchema<FileState>\n  declare stateSchema: ArraySchema<FileState>\n\n  constructor(\n    def: FileUploadFieldComponent,\n    props: ConstructorParameters<typeof FormComponent>[1]\n  ) {\n    super(def, props)\n\n    const { options, schema, title } = def\n\n    let formSchema = joi\n      .array<FileState>()\n      .label(title.toLowerCase())\n      .single()\n      .required()\n\n    if (options.required === false) {\n      formSchema = formSchema.optional()\n    }\n\n    if (typeof schema.length !== 'number') {\n      if (typeof schema.max === 'number') {\n        formSchema = formSchema.max(schema.max)\n      }\n\n      if (typeof schema.min === 'number') {\n        formSchema = formSchema.min(schema.min)\n      }\n    } else {\n      formSchema = formSchema.length(schema.length)\n    }\n\n    this.formSchema = formSchema.items(formItemSchema)\n    this.stateSchema = formSchema\n      .items(formItemSchema)\n      .default(null)\n      .allow(null)\n\n    this.options = options\n    this.schema = schema\n  }\n\n  getFormValueFromState(state: FormSubmissionState) {\n    const { name } = this\n    return this.getFormValue(state[name])\n  }\n\n  getFormValue(value?: FormStateValue | FormState) {\n    return this.isValue(value) ? value : undefined\n  }\n\n  getDisplayStringFromState(state: FormSubmissionState) {\n    const files = this.getFormValueFromState(state)\n    if (!files?.length) {\n      return ''\n    }\n\n    const unit = files.length === 1 ? 'file' : 'files'\n    return `Uploaded ${files.length} ${unit}`\n  }\n\n  getContextValueFromState(state: FormSubmissionState) {\n    const files = this.getFormValueFromState(state)\n    return files?.map(({ status }) => status.form.file.fileId) ?? null\n  }\n\n  getViewModel(\n    payload: FormPayload,\n    errors?: FormSubmissionError[],\n    query: FormQuery = {}\n  ) {\n    const { options, page } = this\n\n    // Allow preview URL direct access\n    const isForceAccess = 'force' in query\n\n    const viewModel = super.getViewModel(payload, errors)\n    const { attributes, id, value } = viewModel\n\n    const files = this.getFormValue(value) ?? []\n    const count = files.length\n\n    let pendingCount = 0\n    let successfulCount = 0\n\n    const rows: SummaryListRow[] = files.map((item, index) => {\n      const { status } = item\n      const { form } = status\n      const { file } = form\n\n      const tag = { classes: 'govuk-tag--red', text: 'Error' }\n\n      if (file.fileStatus === FileStatus.complete) {\n        successfulCount++\n        tag.classes = 'govuk-tag--green'\n        tag.text = 'Uploaded'\n      } else if (file.fileStatus === FileStatus.pending) {\n        pendingCount++\n        tag.classes = 'govuk-tag--yellow'\n        tag.text = 'Uploading'\n      }\n\n      const valueHtml = render\n        .view('components/fileuploadfield-value.html', {\n          context: { params: { tag } }\n        })\n        .trim()\n\n      const keyHtml = render\n        .view('components/fileuploadfield-key.html', {\n          context: {\n            params: {\n              name: file.filename,\n              errorMessage: errors && file.errorMessage\n            }\n          }\n        })\n        .trim()\n\n      const items: SummaryListAction[] = []\n\n      // Remove summary list actions from previews\n      if (!isForceAccess) {\n        const path = `/${item.uploadId}/confirm-delete`\n        const href = page?.getHref(`${page.path}${path}`) ?? '#'\n\n        items.push({\n          href,\n          text: 'Remove',\n          classes: 'govuk-link--no-visited-state',\n          attributes: { id: `${id}__${index}` },\n          visuallyHiddenText: file.filename\n        })\n      }\n\n      return {\n        key: {\n          html: keyHtml\n        },\n        value: {\n          html: valueHtml\n        },\n        actions: {\n          items\n        }\n      } satisfies SummaryListRow\n    })\n\n    // Set up the `accept` attribute\n    if ('accept' in options) {\n      attributes.accept = options.accept\n    }\n\n    const summaryList: SummaryList = {\n      classes: 'govuk-summary-list--long-key',\n      rows\n    }\n\n    return {\n      ...viewModel,\n\n      // File input can't have a initial value\n      value: '',\n\n      // Override the component name we send to CDP\n      name: 'file',\n\n      upload: {\n        count,\n        pendingCount,\n        successfulCount,\n        summaryList\n      }\n    }\n  }\n\n  isValue(value?: FormStateValue | FormState): value is UploadState {\n    return isUploadState(value)\n  }\n}\n"],"mappings":"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","ignoreList":[]}