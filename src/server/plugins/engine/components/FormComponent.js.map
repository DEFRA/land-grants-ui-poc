{"version":3,"file":"FormComponent.js","names":["ComponentBase","optionalText","FormComponent","type","hint","isFormComponent","constructor","def","props","keys","collection","name","fields","map","getFormDataFromState","state","getFormValue","getFormValueFromState","value","isValue","undefined","getStateFromValidForm","payload","getErrors","errors","list","filter","error","path","includes","length","getError","getViewModel","options","title","viewModel","isRequired","required","hideOptional","label","text","componentErrors","componentError","errorMessage","id","getDisplayStringFromState","toString","getContextValueFromState","isState","values","Object","isFormValue","Array","isArray","isFormState","isRepeatState","every","isRepeatValue","itemId","isUploadState","isUploadValue","uploadId"],"sources":["../../../../../src/server/plugins/engine/components/FormComponent.ts"],"sourcesContent":["import { type FormComponentsDef, type Item } from '@defra/forms-model'\n\nimport { ComponentBase } from '~/src/server/plugins/engine/components/ComponentBase.js'\nimport { optionalText } from '~/src/server/plugins/engine/components/constants.js'\nimport {\n  type FileState,\n  type FormPayload,\n  type FormState,\n  type FormStateValue,\n  type FormSubmissionError,\n  type FormSubmissionState,\n  type FormValue,\n  type RepeatItemState,\n  type RepeatListState,\n  type UploadState\n} from '~/src/server/plugins/engine/types.js'\n\nexport class FormComponent extends ComponentBase {\n  type: FormComponentsDef['type']\n  hint: FormComponentsDef['hint']\n\n  isFormComponent = true\n\n  constructor(\n    def: FormComponentsDef,\n    props: ConstructorParameters<typeof ComponentBase>[1]\n  ) {\n    super(def, props)\n\n    const { hint, type } = def\n\n    this.type = type\n    this.hint = hint\n  }\n\n  get keys() {\n    const { collection, name } = this\n\n    if (collection) {\n      const { fields } = collection\n      return [name, ...fields.map(({ name }) => name)]\n    }\n\n    return [name]\n  }\n\n  getFormDataFromState(state: FormSubmissionState): FormPayload {\n    const { collection, name } = this\n\n    if (collection) {\n      return collection.getFormDataFromState(state)\n    }\n\n    return {\n      [name]: this.getFormValue(state[name])\n    }\n  }\n\n  getFormValueFromState(state: FormSubmissionState): FormValue | FormPayload {\n    const { collection, name } = this\n\n    if (collection) {\n      return collection.getFormValueFromState(state)\n    }\n\n    return this.getFormValue(state[name])\n  }\n\n  getFormValue(value?: FormStateValue | FormState) {\n    return this.isValue(value) ? value : undefined\n  }\n\n  getStateFromValidForm(payload: FormPayload): FormState {\n    const { collection, name } = this\n\n    if (collection) {\n      return collection.getStateFromValidForm(payload)\n    }\n\n    return {\n      [name]: this.getFormValue(payload[name]) ?? null\n    }\n  }\n\n  getErrors(errors?: FormSubmissionError[]): FormSubmissionError[] | undefined {\n    const { name } = this\n\n    // Filter component and child errors only\n    const list = errors?.filter(\n      (error) =>\n        error.name === name ||\n        error.path.includes(name) ||\n        this.keys.includes(error.name)\n    )\n\n    if (!list?.length) {\n      return\n    }\n\n    return list\n  }\n\n  getError(errors?: FormSubmissionError[]): FormSubmissionError | undefined {\n    return this.getErrors(errors)?.[0]\n  }\n\n  getViewModel(payload: FormPayload, errors?: FormSubmissionError[]) {\n    const { hint, name, options = {}, title, viewModel } = this\n\n    const isRequired = !('required' in options) || options.required !== false\n    const hideOptional = 'optionalText' in options && options.optionalText\n    const label = `${title}${!isRequired && !hideOptional ? optionalText : ''}`\n\n    if (hint) {\n      viewModel.hint = {\n        text: hint\n      }\n    }\n\n    // Filter component errors only\n    const componentErrors = this.getErrors(errors)\n    const componentError = this.getError(componentErrors)\n\n    if (componentErrors) {\n      viewModel.errors = componentErrors\n    }\n\n    if (componentError) {\n      viewModel.errorMessage = {\n        text: componentError.text\n      }\n    }\n\n    return {\n      ...viewModel,\n      label: {\n        text: label\n      },\n      id: name,\n      name,\n      value: payload[name]\n    }\n  }\n\n  getDisplayStringFromState(state: FormSubmissionState): string {\n    const value = this.getFormValueFromState(state)\n    return this.isValue(value) ? value.toString() : ''\n  }\n\n  getContextValueFromState(\n    state: FormSubmissionState\n  ): Item['value'] | Item['value'][] | null {\n    const value = this.getFormValueFromState(state)\n\n    // Filter object field values\n    if (this.isState(value)) {\n      const values = Object.values(value).filter(isFormValue)\n      return values.length ? values : null\n    }\n\n    // Filter array field values\n    if (this.isValue(value) && Array.isArray(value)) {\n      return value.filter(isFormValue)\n    }\n\n    return this.isValue(value) ? value : null\n  }\n\n  isValue(\n    value?: FormStateValue | FormState\n  ): value is NonNullable<FormStateValue> {\n    return isFormValue(value)\n  }\n\n  isState(value?: FormStateValue | FormState): value is FormState {\n    return isFormState(value)\n  }\n}\n\n/**\n * Check for form value\n */\nexport function isFormValue(\n  value?: unknown\n): value is string | number | boolean {\n  return (\n    (typeof value === 'string' && value.length > 0) ||\n    typeof value === 'number' ||\n    typeof value === 'boolean'\n  )\n}\n\n/**\n * Check for form state with nested values\n */\nexport function isFormState(value?: unknown): value is FormState {\n  if (value === null || typeof value !== 'object' || Array.isArray(value)) {\n    return false\n  }\n\n  // Skip empty objects\n  return !!Object.values(value).length\n}\n\n/**\n * Check for repeat list state\n */\nexport function isRepeatState(value?: unknown): value is RepeatListState {\n  if (!Array.isArray(value)) {\n    return false\n  }\n\n  // Skip checks when empty\n  if (!value.length) {\n    return true\n  }\n\n  return value.every(isRepeatValue)\n}\n\n/**\n * Check for repeat list value\n */\nexport function isRepeatValue(value?: unknown): value is RepeatItemState {\n  return isFormState(value) && typeof value.itemId === 'string'\n}\n\n/**\n * Check for upload state\n */\nexport function isUploadState(value?: unknown): value is UploadState {\n  if (!Array.isArray(value)) {\n    return false\n  }\n\n  // Skip checks when empty\n  if (!value.length) {\n    return true\n  }\n\n  return value.every(isUploadValue)\n}\n\n/**\n * Check for upload state value\n */\nexport function isUploadValue(value?: unknown): value is FileState {\n  return isFormState(value) && typeof value.uploadId === 'string'\n}\n"],"mappings":"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","ignoreList":[]}