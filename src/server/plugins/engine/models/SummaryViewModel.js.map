{"version":3,"file":"SummaryViewModel.js","names":["getAnswer","getError","getPageHref","RepeatPageController","validationOptions","opts","SummaryViewModel","page","pageTitle","declaration","details","checkAnswers","context","name","backLink","feedbackLink","phaseTag","errors","serviceUrl","hasMissingNotificationEmail","constructor","request","model","basePath","def","sections","isForceAccess","title","result","makeFilteredSchema","relevantPages","validate","relevantState","stripUnknown","error","map","summaryDetails","detail","rows","items","item","push","href","text","classes","visuallyHiddenText","label","key","value","html","actions","undefined","summaryList","state","forEach","section","sectionPages","filter","collection","path","ItemRepeat","getSummaryPath","field","fields","ItemField","length","options","repeat","values","getListFromState","unit","returnUrl","subItems","repeatState"],"sources":["../../../../../src/server/plugins/engine/models/SummaryViewModel.ts"],"sourcesContent":["import { type Section } from '@defra/forms-model'\n\nimport {\n  getAnswer,\n  type Field\n} from '~/src/server/plugins/engine/components/helpers.js'\nimport { type BackLink } from '~/src/server/plugins/engine/components/types.js'\nimport { getError, getPageHref } from '~/src/server/plugins/engine/helpers.js'\nimport {\n  type Detail,\n  type DetailItem,\n  type DetailItemField,\n  type DetailItemRepeat\n} from '~/src/server/plugins/engine/models/types.js'\nimport { RepeatPageController } from '~/src/server/plugins/engine/pageControllers/RepeatPageController.js'\nimport { type PageControllerClass } from '~/src/server/plugins/engine/pageControllers/helpers.js'\nimport { validationOptions as opts } from '~/src/server/plugins/engine/pageControllers/validationOptions.js'\nimport {\n  type CheckAnswers,\n  type FormContext,\n  type FormContextRequest,\n  type FormState,\n  type FormSubmissionError,\n  type SummaryListAction,\n  type SummaryListRow\n} from '~/src/server/plugins/engine/types.js'\n\nexport class SummaryViewModel {\n  /**\n   * Responsible for parsing state values to the govuk-frontend summary list template\n   */\n\n  page: PageControllerClass\n  pageTitle: string\n  declaration?: string\n  details: Detail[]\n  checkAnswers: CheckAnswers[]\n  context: FormContext\n  name: string | undefined\n  backLink?: BackLink\n  feedbackLink?: string\n  phaseTag?: string\n  errors?: FormSubmissionError[]\n  serviceUrl: string\n  hasMissingNotificationEmail?: boolean\n\n  constructor(\n    request: FormContextRequest,\n    page: PageControllerClass,\n    context: FormContext\n  ) {\n    const { model } = page\n    const { basePath, def, sections } = model\n    const { isForceAccess } = context\n\n    this.page = page\n    this.pageTitle = page.title\n    this.serviceUrl = `/${basePath}`\n    this.name = def.name\n    this.declaration = def.declaration\n    this.context = context\n\n    const result = model\n      .makeFilteredSchema(this.context.relevantPages)\n      .validate(this.context.relevantState, { ...opts, stripUnknown: true })\n\n    // Format errors\n    this.errors = result.error?.details.map(getError)\n    this.details = this.summaryDetails(request, sections)\n\n    // Format check answers\n    this.checkAnswers = this.details.map((detail): CheckAnswers => {\n      const { title } = detail\n\n      const rows = detail.items.map((item): SummaryListRow => {\n        const items: SummaryListAction[] = []\n\n        // Remove summary list actions from previews\n        if (!isForceAccess) {\n          items.push({\n            href: item.href,\n            text: 'Change',\n            classes: 'govuk-link--no-visited-state',\n            visuallyHiddenText: item.label\n          })\n        }\n\n        return {\n          key: {\n            text: item.title\n          },\n          value: {\n            classes: 'app-prose-scope',\n            html: item.value || 'Not supplied'\n          },\n          actions: {\n            items\n          }\n        }\n      })\n\n      return {\n        title: title ? { text: title } : undefined,\n        summaryList: { rows }\n      }\n    })\n  }\n\n  private summaryDetails(request: FormContextRequest, sections: Section[]) {\n    const { context, errors } = this\n    const { relevantPages, state } = context\n\n    const details: Detail[] = []\n\n    ;[undefined, ...sections].forEach((section) => {\n      const items: DetailItem[] = []\n\n      const sectionPages = relevantPages.filter(\n        (page) => page.section === section\n      )\n\n      sectionPages.forEach((page) => {\n        const { collection, path } = page\n\n        if (page instanceof RepeatPageController) {\n          items.push(\n            ItemRepeat(page, state, {\n              path: page.getSummaryPath(request),\n              errors\n            })\n          )\n        } else {\n          for (const field of collection.fields) {\n            items.push(ItemField(page, state, field, { path, errors }))\n          }\n        }\n      })\n\n      if (items.length) {\n        details.push({\n          name: section?.name,\n          title: section?.title,\n          items\n        })\n      }\n    })\n\n    return details\n  }\n}\n\n/**\n * Creates a repeater detail item\n * @see {@link DetailItemField}\n */\nfunction ItemRepeat(\n  page: RepeatPageController,\n  state: FormState,\n  options: {\n    path: string\n    errors?: FormSubmissionError[]\n  }\n): DetailItemRepeat {\n  const { collection, repeat } = page\n  const { name, title } = repeat.options\n\n  const values = page.getListFromState(state)\n  const unit = values.length === 1 ? title : `${title}s`\n\n  return {\n    name,\n    label: title,\n    title: values.length ? `${unit} added` : unit,\n    value: values.length ? `You added ${values.length} ${unit}` : '',\n    href: getPageHref(page, options.path, {\n      returnUrl: getPageHref(page, page.getSummaryPath())\n    }),\n    state,\n    page,\n\n    // Repeater field detail items\n    subItems: values.map((repeatState) =>\n      collection.fields.map((field) =>\n        ItemField(page, repeatState, field, options)\n      )\n    )\n  }\n}\n\n/**\n * Creates a form field detail item\n * @see {@link DetailItemField}\n */\nfunction ItemField(\n  page: PageControllerClass,\n  state: FormState,\n  field: Field,\n  options: {\n    path: string\n    errors?: FormSubmissionError[]\n  }\n): DetailItemField {\n  return {\n    name: field.name,\n    label: field.title,\n    title: field.title,\n    error: field.getError(options.errors),\n    value: getAnswer(field, state),\n    href: getPageHref(page, options.path, {\n      returnUrl: getPageHref(page, page.getSummaryPath())\n    }),\n    state,\n    page,\n    field\n  }\n}\n"],"mappings":"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","ignoreList":[]}