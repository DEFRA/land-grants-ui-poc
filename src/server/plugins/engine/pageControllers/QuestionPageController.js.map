{"version":3,"file":"QuestionPageController.js","names":["ComponentType","ControllerType","Engine","hasComponents","hasNext","hasRepeater","ComponentCollection","optionalText","getErrors","normalisePath","proceed","PageController","actionSchema","crumbSchema","paramsSchema","merge","QuestionPageController","collection","errorSummaryTitle","constructor","model","pageDef","components","page","formSchema","keys","crumb","action","next","def","filter","path","linkPath","pages","some","pagePath","allowContinue","engine","V2","controller","Terminal","length","getItemId","request","itemId","getFormParams","params","getViewModel","context","viewModel","query","payload","errors","pageTitle","showTitle","formComponents","isFormComponent","fieldset","label","isPageHeading","labelOrLegend","legend","size","classes","isOptional","fields","at","options","required","text","backLink","getBackLink","getRelevantPath","paths","startPath","getStartPath","relevantPath","getNextPath","evaluationState","summaryPath","getSummaryPath","statusPath","getStatusPath","defaultPath","undefined","pageIndex","indexOf","nextPage","slice","find","condition","conditionResult","fn","nextLink","link","conditions","getFormDataFromState","state","result","validate","abortEarly","stripUnknown","value","getStateFromValidForm","details","getState","cacheService","services","setState","mergeState","update","updated","makeGetRouteHandler","h","viewName","component","content","type","Details","map","evaluatedComponent","Array","item","items","hasMissingNotificationEmail","view","isForceAccess","formsService","getFormMetadata","includes","notificationEmail","slug","returnUrl","href","backPath","endsWith","getHref","makePostRouteHandler","nextPath","nextUrl","getRouteOptions","ext","onPostHandler","method","_request","continue","postRouteOptions","parse","maxBytes","Number","MAX_SAFE_INTEGER","failAction"],"sources":["../../../../../src/server/plugins/engine/pageControllers/QuestionPageController.ts"],"sourcesContent":["import {\n  ComponentType,\n  ControllerType,\n  Engine,\n  hasComponents,\n  hasNext,\n  hasRepeater,\n  type Link,\n  type Page\n} from '@defra/forms-model'\nimport { type ResponseToolkit, type RouteOptions } from '@hapi/hapi'\nimport { type ValidationErrorItem } from 'joi'\n\nimport { ComponentCollection } from '~/src/server/plugins/engine/components/ComponentCollection.js'\nimport { optionalText } from '~/src/server/plugins/engine/components/constants.js'\nimport { type BackLink } from '~/src/server/plugins/engine/components/types.js'\nimport {\n  getErrors,\n  normalisePath,\n  proceed\n} from '~/src/server/plugins/engine/helpers.js'\nimport { type FormModel } from '~/src/server/plugins/engine/models/index.js'\nimport { PageController } from '~/src/server/plugins/engine/pageControllers/PageController.js'\nimport {\n  type FormContext,\n  type FormContextRequest,\n  type FormPageViewModel,\n  type FormParams,\n  type FormPayload,\n  type FormState,\n  type FormSubmissionState\n} from '~/src/server/plugins/engine/types.js'\nimport {\n  type FormRequest,\n  type FormRequestPayload,\n  type FormRequestPayloadRefs,\n  type FormRequestRefs\n} from '~/src/server/routes/types.js'\nimport {\n  actionSchema,\n  crumbSchema,\n  paramsSchema\n} from '~/src/server/schemas/index.js'\nimport { merge } from '~/src/server/services/cacheService.js'\n\nexport class QuestionPageController extends PageController {\n  collection: ComponentCollection\n  errorSummaryTitle = 'There is a problem'\n\n  constructor(model: FormModel, pageDef: Page) {\n    super(model, pageDef)\n\n    // Components collection\n    this.collection = new ComponentCollection(\n      hasComponents(pageDef) ? pageDef.components : [],\n      { model, page: this }\n    )\n\n    this.collection.formSchema = this.collection.formSchema.keys({\n      crumb: crumbSchema,\n      action: actionSchema\n    })\n  }\n\n  get next(): Link[] {\n    const { def, pageDef } = this\n\n    if (!hasNext(pageDef)) {\n      return []\n    }\n\n    // Remove stale links\n    return pageDef.next.filter(({ path }) => {\n      const linkPath = normalisePath(path)\n\n      return def.pages.some((page) => {\n        const pagePath = normalisePath(page.path)\n        return pagePath === linkPath\n      })\n    })\n  }\n\n  get allowContinue(): boolean {\n    if (this.model.engine === Engine.V2) {\n      return this.pageDef.controller !== ControllerType.Terminal\n    }\n\n    return this.next.length > 0\n  }\n\n  getItemId(request?: FormContextRequest) {\n    const { itemId } = this.getFormParams(request)\n    return itemId ?? request?.params.itemId\n  }\n\n  /**\n   * Used for mapping form payloads and errors to govuk-frontend's template api, so a page can be rendered\n   * @param request - the hapi request\n   * @param context - the form context\n   */\n  getViewModel(\n    request: FormContextRequest,\n    context: FormContext\n  ): FormPageViewModel {\n    const { collection, viewModel } = this\n    const { query } = request\n    const { payload, errors } = context\n\n    let { pageTitle, showTitle } = viewModel\n\n    const components = collection.getViewModel(payload, errors, query)\n    const formComponents = components.filter(\n      ({ isFormComponent }) => isFormComponent\n    )\n\n    // Single form component? Hide title and customise label or legend instead\n    if (formComponents.length === 1) {\n      const { model } = formComponents[0]\n      const { fieldset, label } = model\n\n      // Set as page heading when not following other content\n      const isPageHeading = formComponents[0] === components[0]\n\n      // Check for legend or label\n      const labelOrLegend = fieldset?.legend ?? label\n\n      // Use legend or label as page heading\n      if (labelOrLegend) {\n        const size = isPageHeading ? 'l' : 'm'\n\n        labelOrLegend.classes =\n          labelOrLegend === label\n            ? `govuk-label--${size}`\n            : `govuk-fieldset__legend--${size}`\n\n        if (isPageHeading) {\n          labelOrLegend.isPageHeading = isPageHeading\n\n          // Check for optional in label\n          const isOptional =\n            this.collection.fields.at(0)?.options.required === false\n\n          if (pageTitle) {\n            labelOrLegend.text = isOptional\n              ? `${pageTitle}${optionalText}`\n              : pageTitle\n          }\n\n          pageTitle = pageTitle || labelOrLegend.text\n        }\n      }\n\n      showTitle = !isPageHeading\n    }\n\n    return {\n      ...viewModel,\n      backLink: this.getBackLink(request, context),\n      context,\n      showTitle,\n      components,\n      errors\n    }\n  }\n\n  getRelevantPath(\n    request: FormRequest | FormRequestPayload,\n    context: FormContext\n  ) {\n    const { paths } = context\n\n    const startPath = this.getStartPath()\n    const relevantPath = paths.at(-1) ?? startPath\n\n    return !paths.length\n      ? startPath // First possible path\n      : relevantPath // Last possible path\n  }\n\n  /**\n   * Apply conditions to evaluation state to determine next page path\n   */\n  getNextPath(context: FormContext) {\n    const { model, next, path } = this\n    const { evaluationState } = context\n\n    const summaryPath = this.getSummaryPath()\n    const statusPath = this.getStatusPath()\n\n    // Walk from summary page (no next links) to status page\n    let defaultPath = path === summaryPath ? statusPath : undefined\n\n    if (model.engine === Engine.V2) {\n      if (this.pageDef.controller !== ControllerType.Terminal) {\n        const { pages } = this.model\n        const pageIndex = pages.indexOf(this)\n\n        // The \"next\" page is the first found after the current which is\n        // either unconditional or has a condition that evaluates to \"true\"\n        const nextPage = pages.slice(pageIndex + 1).find((page) => {\n          const { condition } = page\n\n          if (condition) {\n            const conditionResult = condition.fn(evaluationState)\n\n            if (!conditionResult) {\n              return false\n            }\n          }\n\n          return true\n        })\n\n        return nextPage?.path ?? defaultPath\n      } else {\n        return defaultPath\n      }\n    }\n\n    const nextLink = next.find((link) => {\n      const { condition } = link\n\n      if (condition) {\n        return model.conditions[condition]?.fn(evaluationState) ?? false\n      }\n\n      defaultPath = link.path\n      return false\n    })\n\n    return nextLink?.path ?? defaultPath\n  }\n\n  /**\n   * Gets the form payload (from state) for this page only\n   */\n  getFormDataFromState(\n    request: FormContextRequest | undefined,\n    state: FormSubmissionState\n  ): FormPayload {\n    const { collection } = this\n\n    // Form params from request\n    const params = this.getFormParams(request)\n\n    // Form payload from state\n    const payload = collection.getFormDataFromState(state)\n\n    return {\n      ...params,\n      ...payload\n    }\n  }\n\n  /**\n   * Gets form params (from payload) for this page only\n   */\n  getFormParams(request?: FormContextRequest): FormParams {\n    const { payload } = request ?? {}\n\n    const result = paramsSchema.validate(payload, {\n      abortEarly: false,\n      stripUnknown: true\n    })\n\n    return result.value as FormParams\n  }\n\n  getStateFromValidForm(\n    request: FormContextRequest,\n    state: FormSubmissionState,\n    payload: FormPayload\n  ): FormState {\n    return this.collection.getStateFromValidForm(payload)\n  }\n\n  getErrors(details?: ValidationErrorItem[]) {\n    return getErrors(details)\n  }\n\n  async getState(request: FormRequest | FormRequestPayload) {\n    const { query } = request\n\n    // Skip get for preview URL direct access\n    if ('force' in query) {\n      return {}\n    }\n\n    const { cacheService } = request.services([])\n    return cacheService.getState(request)\n  }\n\n  async setState(\n    request: FormRequest | FormRequestPayload,\n    state: FormSubmissionState\n  ) {\n    const { query } = request\n\n    // Skip set for preview URL direct access\n    if ('force' in query) {\n      return state\n    }\n\n    const { cacheService } = request.services([])\n    return cacheService.setState(request, state)\n  }\n\n  async mergeState(\n    request: FormRequest | FormRequestPayload,\n    state: FormSubmissionState,\n    update: object\n  ) {\n    const { query } = request\n\n    // Merge state before set\n    const updated = merge(state, update)\n\n    // Skip set for preview URL direct access\n    if ('force' in query) {\n      return updated\n    }\n\n    const { cacheService } = request.services([])\n    return cacheService.setState(request, updated)\n  }\n\n  makeGetRouteHandler() {\n    return async (\n      request: FormRequest,\n      context: FormContext,\n      h: Pick<ResponseToolkit, 'redirect' | 'view'>\n    ) => {\n      const { collection, model, viewName } = this\n      const { evaluationState } = context\n\n      const viewModel = this.getViewModel(request, context)\n      viewModel.errors = collection.getErrors(viewModel.errors)\n\n      /**\n       * Content components can be hidden based on a condition. If the condition evaluates to true, it is safe to be kept, otherwise discard it\n       */\n\n      // Filter our components based on their conditions using our evaluated state\n      viewModel.components = viewModel.components.filter((component) => {\n        if (\n          (!!component.model.content ||\n            component.type === ComponentType.Details) &&\n          component.model.condition\n        ) {\n          const condition = model.conditions[component.model.condition]\n          return condition?.fn(evaluationState)\n        }\n        return true\n      })\n\n      /**\n       * For conditional reveal components (which we no longer support until GDS resolves the related accessibility issues {@link https://github.com/alphagov/govuk-frontend/issues/1991}\n       */\n      viewModel.components = viewModel.components.map((component) => {\n        const evaluatedComponent = component\n        const content = evaluatedComponent.model.content\n        if (content instanceof Array) {\n          evaluatedComponent.model.content = content.filter((item) =>\n            item.condition\n              ? model.conditions[item.condition]?.fn(evaluationState)\n              : true\n          )\n        }\n        // apply condition to items for radios, checkboxes etc\n        const items = evaluatedComponent.model.items\n\n        if (items instanceof Array) {\n          evaluatedComponent.model.items = items.filter((item) =>\n            item.condition\n              ? model.conditions[item.condition]?.fn(evaluationState)\n              : true\n          )\n        }\n\n        return evaluatedComponent\n      })\n\n      viewModel.hasMissingNotificationEmail =\n        await this.hasMissingNotificationEmail(request, context)\n\n      return h.view(viewName, viewModel)\n    }\n  }\n\n  async hasMissingNotificationEmail(\n    request: FormRequest,\n    context: FormContext\n  ) {\n    const { path } = this\n    const { params } = request\n    const { isForceAccess } = context\n\n    const startPath = this.getStartPath()\n    const summaryPath = this.getSummaryPath()\n    const { formsService } = this.model.services\n    const { getFormMetadata } = formsService\n\n    // Warn the user if the form has no notification email set only on start page and summary page\n    if ([startPath, summaryPath].includes(path) && !isForceAccess) {\n      const { notificationEmail } = await getFormMetadata(params.slug)\n      return !notificationEmail\n    }\n\n    return false\n  }\n\n  /**\n   * Get the back link for a given progress.\n   */\n  protected getBackLink(\n    request: FormContextRequest,\n    context: FormContext\n  ): BackLink | undefined {\n    const { pageDef } = this\n    const { path, query } = request\n    const { returnUrl } = query\n    const { paths } = context\n\n    const itemId = this.getItemId(request)\n\n    // Check answers back link\n    if (returnUrl) {\n      return {\n        text:\n          hasRepeater(pageDef) && itemId\n            ? 'Go back to add another'\n            : 'Go back to check answers',\n        href: returnUrl\n      }\n    }\n\n    // Item delete pages etc\n    const backPath =\n      itemId && !path.endsWith(itemId)\n        ? paths.at(-1) // Back to main page\n        : paths.at(-2) // Back to previous page\n\n    // No back link\n    if (!backPath) {\n      return\n    }\n\n    // Default back link\n    return {\n      text: 'Back',\n      href: this.getHref(backPath)\n    }\n  }\n\n  makePostRouteHandler() {\n    return async (\n      request: FormRequestPayload,\n      context: FormContext,\n      h: Pick<ResponseToolkit, 'redirect' | 'view'>\n    ) => {\n      const { collection, viewName } = this\n      const { isForceAccess, state } = context\n\n      /**\n       * If there are any errors, render the page with the parsed errors\n       * @todo Refactor to match POST REDIRECT GET pattern\n       */\n      if (context.errors || isForceAccess) {\n        const viewModel = this.getViewModel(request, context)\n        viewModel.errors = collection.getErrors(viewModel.errors)\n\n        return h.view(viewName, viewModel)\n      }\n\n      // Save and proceed\n      await this.setState(request, state)\n      return this.proceed(request, h, this.getNextPath(context))\n    }\n  }\n\n  proceed(\n    request: FormContextRequest,\n    h: Pick<ResponseToolkit, 'redirect' | 'view'>,\n    nextPath?: string\n  ) {\n    const nextUrl = nextPath\n      ? this.getHref(nextPath) // Redirect to next page\n      : this.href // Redirect to current page (refresh)\n\n    return proceed(request, h, nextUrl)\n  }\n\n  /**\n   * {@link https://hapi.dev/api/?v=20.1.2#route-options}\n   */\n  get getRouteOptions(): RouteOptions<FormRequestRefs> {\n    return {\n      ext: {\n        onPostHandler: {\n          method(_request, h) {\n            return h.continue\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * {@link https://hapi.dev/api/?v=20.1.2#route-options}\n   */\n  get postRouteOptions(): RouteOptions<FormRequestPayloadRefs> {\n    return {\n      payload: {\n        parse: true,\n        maxBytes: Number.MAX_SAFE_INTEGER,\n        failAction: 'ignore'\n      },\n      ext: {\n        onPostHandler: {\n          method(_request, h) {\n            return h.continue\n          }\n        }\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}