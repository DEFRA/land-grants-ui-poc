{"version":3,"file":"ListFormComponent.js","names":["joi","FormComponent","ListFormComponent","list","listType","items","values","map","value","constructor","def","props","options","title","model","getList","type","formSchema","valid","label","toLowerCase","required","customValidationMessages","messages","stateSchema","default","allow","getFormValueFromState","state","name","isValue","flat","selected","filter","item","includes","at","getDisplayStringFromState","text","join","getViewModel","payload","errors","listItems","viewModel","itemModel","description","hint"],"sources":["../../../../../src/server/plugins/engine/components/ListFormComponent.ts"],"sourcesContent":["import {\n  type Item,\n  type List,\n  type ListComponentsDef,\n  type SelectionComponentsDef,\n  type YesNoFieldComponent\n} from '@defra/forms-model'\nimport joi, {\n  type ArraySchema,\n  type BooleanSchema,\n  type NumberSchema,\n  type StringSchema\n} from 'joi'\n\nimport { FormComponent } from '~/src/server/plugins/engine/components/FormComponent.js'\nimport { type ListItem } from '~/src/server/plugins/engine/components/types.js'\nimport {\n  type FormPayload,\n  type FormSubmissionError,\n  type FormSubmissionState\n} from '~/src/server/plugins/engine/types.js'\n\nexport class ListFormComponent extends FormComponent {\n  declare options: Extract<\n    SelectionComponentsDef,\n    { options: object }\n  >['options']\n\n  declare formSchema:\n    | ArraySchema<string>\n    | ArraySchema<number>\n    | BooleanSchema<string>\n    | NumberSchema<string>\n    | NumberSchema\n    | StringSchema\n\n  declare stateSchema:\n    | ArraySchema<string>\n    | ArraySchema<number>\n    | BooleanSchema<string>\n    | NumberSchema<string>\n    | NumberSchema\n    | StringSchema\n\n  list?: List\n  listType: List['type'] = 'string'\n\n  get items(): Item[] {\n    return this.list?.items ?? []\n  }\n\n  get values(): Item['value'][] {\n    return this.items.map(({ value }) => value)\n  }\n\n  constructor(\n    def:\n      | SelectionComponentsDef // Allow for Yes/No field custom list\n      | (YesNoFieldComponent & Pick<ListComponentsDef, 'list'>),\n    props: ConstructorParameters<typeof FormComponent>[1]\n  ) {\n    super(def, props)\n\n    const { options, title } = def\n    const { model } = props\n\n    if ('list' in def) {\n      this.list = model.getList(def.list)\n      this.listType = this.list?.type ?? 'string'\n    }\n\n    let formSchema = joi[this.listType]()\n      .valid(...this.values)\n      .label(title.toLowerCase())\n      .required()\n\n    if (options.customValidationMessages) {\n      formSchema = formSchema.messages(options.customValidationMessages)\n    }\n\n    this.formSchema = formSchema\n    this.stateSchema = formSchema.default(null).allow(null)\n    this.options = options\n  }\n\n  getFormValueFromState(\n    state: FormSubmissionState\n  ): Item['value'] | Item['value'][] | undefined {\n    const { name, items } = this\n\n    const value = state[name]\n\n    // Allow for array values via subclass\n    const values = this.isValue(value) ? [value].flat() : []\n    const selected = items.filter((item) => values.includes(item.value))\n\n    return selected.at(0)?.value\n  }\n\n  getDisplayStringFromState(state: FormSubmissionState) {\n    const { items } = this\n\n    // Allow for array values via subclass\n    const value = this.getFormValueFromState(state)\n    const values = [value ?? []].flat()\n\n    return items\n      .filter((item) => values.includes(item.value))\n      .map((item) => item.text)\n      .join(', ')\n  }\n\n  getViewModel(payload: FormPayload, errors?: FormSubmissionError[]) {\n    const { items: listItems } = this\n\n    const viewModel = super.getViewModel(payload, errors)\n    const { value } = viewModel\n\n    // Support multiple values for checkboxes\n    const values = this.isValue(value) ? [value].flat() : []\n\n    const items = listItems.map((item) => {\n      const selected = values.includes(item.value)\n      const itemModel: ListItem = { ...item, selected }\n\n      if (item.description) {\n        itemModel.hint = {\n          text: item.description\n        }\n      }\n\n      return itemModel\n    })\n\n    return {\n      ...viewModel,\n      items\n    }\n  }\n}\n"],"mappings":"AAOA,OAAOA,GAAG,MAKH,KAAK;AAEZ,SAASC,aAAa;AAQtB,OAAO,MAAMC,iBAAiB,SAASD,aAAa,CAAC;EAsBnDE,IAAI;EACJC,QAAQ,GAAiB,QAAQ;EAEjC,IAAIC,KAAKA,CAAA,EAAW;IAClB,OAAO,IAAI,CAACF,IAAI,EAAEE,KAAK,IAAI,EAAE;EAC/B;EAEA,IAAIC,MAAMA,CAAA,EAAoB;IAC5B,OAAO,IAAI,CAACD,KAAK,CAACE,GAAG,CAAC,CAAC;MAAEC;IAAM,CAAC,KAAKA,KAAK,CAAC;EAC7C;EAEAC,WAAWA,CACTC,GAE2D,EAC3DC,KAAqD,EACrD;IACA,KAAK,CAACD,GAAG,EAAEC,KAAK,CAAC;IAEjB,MAAM;MAAEC,OAAO;MAAEC;IAAM,CAAC,GAAGH,GAAG;IAC9B,MAAM;MAAEI;IAAM,CAAC,GAAGH,KAAK;IAEvB,IAAI,MAAM,IAAID,GAAG,EAAE;MACjB,IAAI,CAACP,IAAI,GAAGW,KAAK,CAACC,OAAO,CAACL,GAAG,CAACP,IAAI,CAAC;MACnC,IAAI,CAACC,QAAQ,GAAG,IAAI,CAACD,IAAI,EAAEa,IAAI,IAAI,QAAQ;IAC7C;IAEA,IAAIC,UAAU,GAAGjB,GAAG,CAAC,IAAI,CAACI,QAAQ,CAAC,CAAC,CAAC,CAClCc,KAAK,CAAC,GAAG,IAAI,CAACZ,MAAM,CAAC,CACrBa,KAAK,CAACN,KAAK,CAACO,WAAW,CAAC,CAAC,CAAC,CAC1BC,QAAQ,CAAC,CAAC;IAEb,IAAIT,OAAO,CAACU,wBAAwB,EAAE;MACpCL,UAAU,GAAGA,UAAU,CAACM,QAAQ,CAACX,OAAO,CAACU,wBAAwB,CAAC;IACpE;IAEA,IAAI,CAACL,UAAU,GAAGA,UAAU;IAC5B,IAAI,CAACO,WAAW,GAAGP,UAAU,CAACQ,OAAO,CAAC,IAAI,CAAC,CAACC,KAAK,CAAC,IAAI,CAAC;IACvD,IAAI,CAACd,OAAO,GAAGA,OAAO;EACxB;EAEAe,qBAAqBA,CACnBC,KAA0B,EACmB;IAC7C,MAAM;MAAEC,IAAI;MAAExB;IAAM,CAAC,GAAG,IAAI;IAE5B,MAAMG,KAAK,GAAGoB,KAAK,CAACC,IAAI,CAAC;;IAEzB;IACA,MAAMvB,MAAM,GAAG,IAAI,CAACwB,OAAO,CAACtB,KAAK,CAAC,GAAG,CAACA,KAAK,CAAC,CAACuB,IAAI,CAAC,CAAC,GAAG,EAAE;IACxD,MAAMC,QAAQ,GAAG3B,KAAK,CAAC4B,MAAM,CAAEC,IAAI,IAAK5B,MAAM,CAAC6B,QAAQ,CAACD,IAAI,CAAC1B,KAAK,CAAC,CAAC;IAEpE,OAAOwB,QAAQ,CAACI,EAAE,CAAC,CAAC,CAAC,EAAE5B,KAAK;EAC9B;EAEA6B,yBAAyBA,CAACT,KAA0B,EAAE;IACpD,MAAM;MAAEvB;IAAM,CAAC,GAAG,IAAI;;IAEtB;IACA,MAAMG,KAAK,GAAG,IAAI,CAACmB,qBAAqB,CAACC,KAAK,CAAC;IAC/C,MAAMtB,MAAM,GAAG,CAACE,KAAK,IAAI,EAAE,CAAC,CAACuB,IAAI,CAAC,CAAC;IAEnC,OAAO1B,KAAK,CACT4B,MAAM,CAAEC,IAAI,IAAK5B,MAAM,CAAC6B,QAAQ,CAACD,IAAI,CAAC1B,KAAK,CAAC,CAAC,CAC7CD,GAAG,CAAE2B,IAAI,IAAKA,IAAI,CAACI,IAAI,CAAC,CACxBC,IAAI,CAAC,IAAI,CAAC;EACf;EAEAC,YAAYA,CAACC,OAAoB,EAAEC,MAA8B,EAAE;IACjE,MAAM;MAAErC,KAAK,EAAEsC;IAAU,CAAC,GAAG,IAAI;IAEjC,MAAMC,SAAS,GAAG,KAAK,CAACJ,YAAY,CAACC,OAAO,EAAEC,MAAM,CAAC;IACrD,MAAM;MAAElC;IAAM,CAAC,GAAGoC,SAAS;;IAE3B;IACA,MAAMtC,MAAM,GAAG,IAAI,CAACwB,OAAO,CAACtB,KAAK,CAAC,GAAG,CAACA,KAAK,CAAC,CAACuB,IAAI,CAAC,CAAC,GAAG,EAAE;IAExD,MAAM1B,KAAK,GAAGsC,SAAS,CAACpC,GAAG,CAAE2B,IAAI,IAAK;MACpC,MAAMF,QAAQ,GAAG1B,MAAM,CAAC6B,QAAQ,CAACD,IAAI,CAAC1B,KAAK,CAAC;MAC5C,MAAMqC,SAAmB,GAAG;QAAE,GAAGX,IAAI;QAAEF;MAAS,CAAC;MAEjD,IAAIE,IAAI,CAACY,WAAW,EAAE;QACpBD,SAAS,CAACE,IAAI,GAAG;UACfT,IAAI,EAAEJ,IAAI,CAACY;QACb,CAAC;MACH;MAEA,OAAOD,SAAS;IAClB,CAAC,CAAC;IAEF,OAAO;MACL,GAAGD,SAAS;MACZvC;IACF,CAAC;EACH;AACF","ignoreList":[]}